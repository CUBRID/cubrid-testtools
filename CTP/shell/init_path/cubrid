#!/bin/bash

if [ ! -f $CUBRID/bin/cub_server ]; then
	exit 127
fi
source $init_path/shell_utils.sh

cub_util=$(echo $1|tr "[A-Z]" "[a-z]") >/dev/null 2>&1

export PATH=$CUBRID/bin:$PATH >/dev/null

if [ "$OS" != "Windows_NT" -a "$cub_util" == "deletedb" ]; then
    do_check_more_errors "`pwd`" >/dev/null 2>&1
elif [ "$cub_util" == "server" -o "$cub_util" == "checkdb" ]; then
    cubrid "$@" > cubrid_failure_desc.txt 2>&1
    exit_value=$?
    cat cubrid_failure_desc.txt
    if [ ${exit_value} -ne 0 -a "${SKIP_CHECK_RECOVERY_ERROR}" != "TRUE" ]; then
        cmd_kind=""
        if [ "$cub_util" == "checkdb" ]; then
            cmd_kind="CHECKDB"
        else
            is_server_start=`echo "$@" | grep "start " | wc -l`
            if [ ${is_server_start} -ge 1 ]; then
                cmd_kind="SERVER-START"
            fi
        fi
        if [ "$cmd_kind" != "" ]; then
            hit_flag=`should_save_snapshot_for_recovery cubrid_failure_desc.txt`
            if [ ${hit_flag} -eq 1 ]; then
                do_save_snapshot_by_type "`pwd`" ${cmd_kind} >/dev/null 2>&1
            fi
        fi
    fi
    rm -rf cubrid_failure_desc.txt >/dev/null 2>&1
	exit ${exit_value}
fi
cubrid "$@"